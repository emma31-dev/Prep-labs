# PDF Export Integration Guide

This document outlines how to implement PDF export functionality for quizzes using jsPDF, allowing users to download their created quizzes for offline practice.

## Overview

The PDF export system will generate professional-looking PDF documents containing:
- Quiz questions with multiple choice options
- Answer sheets (separate or combined)
- Quiz metadata (title, difficulty, time limit, etc.)
- Branding and formatting
- Optional answer key for educators

## Dependencies

```bash
pnpm install jspdf jspdf-autotable
pnpm install --save-dev @types/jspdf
```

## Implementation Strategy

### 1. PDF Export Service

Create a dedicated service for handling PDF generation:

```typescript
// src/services/pdfExportService.ts
import jsPDF from 'jspdf';
import 'jspdf-autotable';
import { Quiz, Question } from '../types/quiz';

interface PDFExportOptions {
  includeAnswers: boolean;
  separateAnswerSheet: boolean;
  includeInstructions: boolean;
  pageFormat: 'A4' | 'Letter';
  fontSize: 'small' | 'medium' | 'large';
  includeHeader: boolean;
  includeBranding: boolean;
}

export class PDFExportService {
  private doc: jsPDF;
  private pageWidth: number;
  private pageHeight: number;
  private margin: number = 20;
  private currentY: number = 20;

  constructor(format: 'A4' | 'Letter' = 'A4') {
    this.doc = new jsPDF('p', 'mm', format.toLowerCase());
    this.pageWidth = this.doc.internal.pageSize.getWidth();
    this.pageHeight = this.doc.internal.pageSize.getHeight();
  }

  exportQuiz(quiz: Quiz, options: PDFExportOptions): void {
    this.setupDocument(quiz, options);
    
    if (options.includeInstructions) {
      this.addInstructions(quiz);
    }

    this.addQuestions(quiz.questions, options);

    if (options.includeAnswers && !options.separateAnswerSheet) {
      this.addNewPage();
      this.addAnswerKey(quiz.questions);
    } else if (options.separateAnswerSheet) {
      this.generateAnswerSheet(quiz, options);
    }

    this.saveDocument(quiz.title);
  }

  private setupDocument(quiz: Quiz, options: PDFExportOptions): void {
    // Set font
    this.doc.setFont('helvetica');
    
    // Add header if enabled
    if (options.includeHeader) {
      this.addHeader(quiz);
    }

    // Add branding if enabled
    if (options.includeBranding) {
      this.addBranding();
    }
  }

  private addHeader(quiz: Quiz): void {
    this.doc.setFontSize(20);
    this.doc.setFont('helvetica', 'bold');
    
    // Quiz title
    const titleLines = this.doc.splitTextToSize(quiz.title, this.pageWidth - 2 * this.margin);
    this.doc.text(titleLines, this.margin, this.currentY);
    this.currentY += titleLines.length * 8;

    // Quiz metadata
    this.doc.setFontSize(12);
    this.doc.setFont('helvetica', 'normal');
    
    const metadata = [
      `Difficulty: ${quiz.difficulty.charAt(0).toUpperCase() + quiz.difficulty.slice(1)}`,
      `Questions: ${quiz.total_questions}`,
      `Time Limit: ${quiz.time_limit_minutes} minutes`,
      `Created: ${new Date(quiz.created_at).toLocaleDateString()}`
    ];

    metadata.forEach(item => {
      this.currentY += 6;
      this.doc.text(item, this.margin, this.currentY);
    });

    this.currentY += 15;
    this.addSeparatorLine();
  }

  private addBranding(): void {
    // Add logo/branding at top right
    this.doc.setFontSize(10);
    this.doc.setFont('helvetica', 'italic');
    this.doc.text('Generated by QuizApp', this.pageWidth - this.margin - 40, 15);
  }

  private addInstructions(quiz: Quiz): void {
    this.doc.setFontSize(14);
    this.doc.setFont('helvetica', 'bold');
    this.doc.text('Instructions:', this.margin, this.currentY);
    this.currentY += 8;

    this.doc.setFontSize(11);
    this.doc.setFont('helvetica', 'normal');
    
    const instructions = [
      '• Read each question carefully before selecting your answer',
      '• Choose the best answer from the given options',
      '• Mark your answers clearly on the answer sheet',
      `• You have ${quiz.time_limit_minutes} minutes to complete this quiz`,
      '• Do not leave any questions unanswered if possible'
    ];

    instructions.forEach(instruction => {
      this.doc.text(instruction, this.margin, this.currentY);
      this.currentY += 6;
    });

    this.currentY += 10;
    this.addSeparatorLine();
  }

  private addQuestions(questions: Question[], options: PDFExportOptions): void {
    questions.forEach((question, index) => {
      this.checkPageBreak(60); // Ensure enough space for question

      // Question number and text
      this.doc.setFontSize(12);
      this.doc.setFont('helvetica', 'bold');
      this.doc.text(`${index + 1}.`, this.margin, this.currentY);
      
      const questionText = this.doc.splitTextToSize(
        question.question, 
        this.pageWidth - this.margin - 30
      );
      
      this.doc.text(questionText, this.margin + 10, this.currentY);
      this.currentY += questionText.length * 6 + 5;

      // Answer options
      this.doc.setFont('helvetica', 'normal');
      this.doc.setFontSize(11);

      question.options.forEach((option, optionIndex) => {
        const optionLetter = String.fromCharCode(65 + optionIndex); // A, B, C, D
        const optionText = this.doc.splitTextToSize(
          `${optionLetter}. ${option}`,
          this.pageWidth - this.margin - 40
        );
        
        this.doc.text(optionText, this.margin + 15, this.currentY);
        this.currentY += optionText.length * 5 + 3;
      });

      // Add answer if included and not separate
      if (options.includeAnswers && !options.separateAnswerSheet) {
        this.doc.setFont('helvetica', 'italic');
        this.doc.setFontSize(10);
        const correctLetter = String.fromCharCode(65 + question.correct_answer);
        this.doc.text(`Answer: ${correctLetter}`, this.margin + 15, this.currentY);
        this.currentY += 8;
      }

      this.currentY += 10; // Space between questions
    });
  }

  private addAnswerKey(questions: Question[]): void {
    this.doc.setFontSize(16);
    this.doc.setFont('helvetica', 'bold');
    this.doc.text('Answer Key', this.margin, this.currentY);
    this.currentY += 15;

    // Create answer table
    const answerData = questions.map((question, index) => {
      const correctLetter = String.fromCharCode(65 + question.correct_answer);
      return [
        (index + 1).toString(),
        correctLetter,
        question.explanation || 'No explanation provided'
      ];
    });

    (this.doc as any).autoTable({
      startY: this.currentY,
      head: [['Question', 'Answer', 'Explanation']],
      body: answerData,
      theme: 'grid',
      styles: { fontSize: 10 },
      headStyles: { fillColor: [66, 139, 202] },
      columnStyles: {
        0: { cellWidth: 20 },
        1: { cellWidth: 20 },
        2: { cellWidth: this.pageWidth - 80 }
      }
    });
  }

  private generateAnswerSheet(quiz: Quiz, options: PDFExportOptions): void {
    // Create separate answer sheet page
    this.addNewPage();
    
    this.doc.setFontSize(18);
    this.doc.setFont('helvetica', 'bold');
    this.doc.text('Answer Sheet', this.margin, this.currentY);
    this.currentY += 10;

    this.doc.setFontSize(12);
    this.doc.setFont('helvetica', 'normal');
    this.doc.text(`Name: ${'_'.repeat(40)}`, this.margin, this.currentY);
    this.currentY += 10;
    this.doc.text(`Date: ${'_'.repeat(20)}`, this.margin, this.currentY);
    this.currentY += 15;

    // Create answer bubbles/boxes
    const questionsPerRow = 5;
    const rows = Math.ceil(quiz.questions.length / questionsPerRow);
    
    for (let row = 0; row < rows; row++) {
      this.checkPageBreak(40);
      
      for (let col = 0; col < questionsPerRow; col++) {
        const questionIndex = row * questionsPerRow + col;
        if (questionIndex >= quiz.questions.length) break;

        const x = this.margin + col * 35;
        const y = this.currentY;

        // Question number
        this.doc.setFont('helvetica', 'bold');
        this.doc.text(`${questionIndex + 1}`, x, y);

        // Answer options (A, B, C, D)
        this.doc.setFont('helvetica', 'normal');
        ['A', 'B', 'C', 'D'].forEach((letter, letterIndex) => {
          const optionX = x + 5 + letterIndex * 5;
          this.doc.circle(optionX, y + 3, 2, 'S');
          this.doc.text(letter, optionX - 1, y + 8);
        });
      }
      this.currentY += 25;
    }

    // Add answer key if requested
    if (options.includeAnswers) {
      this.addNewPage();
      this.addAnswerKey(quiz.questions);
    }
  }

  private checkPageBreak(requiredSpace: number): void {
    if (this.currentY + requiredSpace > this.pageHeight - this.margin) {
      this.addNewPage();
    }
  }

  private addNewPage(): void {
    this.doc.addPage();
    this.currentY = this.margin;
  }

  private addSeparatorLine(): void {
    this.doc.line(this.margin, this.currentY, this.pageWidth - this.margin, this.currentY);
    this.currentY += 10;
  }

  private saveDocument(title: string): void {
    const filename = `${title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_quiz.pdf`;
    this.doc.save(filename);
  }
}
```

### 2. PDF Export Hook

Create a hook to manage PDF export functionality:

```typescript
// src/hooks/usePDFExport.ts
import { useState } from 'react';
import { PDFExportService, PDFExportOptions } from '../services/pdfExportService';
import { Quiz } from '../types/quiz';

export const usePDFExport = () => {
  const [isExporting, setIsExporting] = useState(false);
  const [exportError, setExportError] = useState<string | null>(null);

  const exportToPDF = async (quiz: Quiz, options: PDFExportOptions) => {
    setIsExporting(true);
    setExportError(null);

    try {
      const pdfService = new PDFExportService(options.pageFormat);
      pdfService.exportQuiz(quiz, options);
    } catch (error) {
      setExportError(error instanceof Error ? error.message : 'Failed to export PDF');
    } finally {
      setIsExporting(false);
    }
  };

  const exportQuizOnly = (quiz: Quiz) => {
    const defaultOptions: PDFExportOptions = {
      includeAnswers: false,
      separateAnswerSheet: false,
      includeInstructions: true,
      pageFormat: 'A4',
      fontSize: 'medium',
      includeHeader: true,
      includeBranding: true
    };
    
    return exportToPDF(quiz, defaultOptions);
  };

  const exportWithAnswers = (quiz: Quiz) => {
    const optionsWithAnswers: PDFExportOptions = {
      includeAnswers: true,
      separateAnswerSheet: false,
      includeInstructions: true,
      pageFormat: 'A4',
      fontSize: 'medium',
      includeHeader: true,
      includeBranding: true
    };
    
    return exportToPDF(quiz, optionsWithAnswers);
  };

  const exportWithAnswerSheet = (quiz: Quiz) => {
    const answerSheetOptions: PDFExportOptions = {
      includeAnswers: true,
      separateAnswerSheet: true,
      includeInstructions: true,
      pageFormat: 'A4',
      fontSize: 'medium',
      includeHeader: true,
      includeBranding: true
    };
    
    return exportToPDF(quiz, answerSheetOptions);
  };

  return {
    isExporting,
    exportError,
    exportToPDF,
    exportQuizOnly,
    exportWithAnswers,
    exportWithAnswerSheet
  };
};
```

### 3. PDF Export Options Modal

Create a modal for users to customize their PDF export:

```typescript
// src/components/quiz/PDFExportModal.tsx
import React, { useState } from 'react';
import { X, Download, FileText, Key, ClipboardList } from 'lucide-react';
import { Quiz } from '../../types/quiz';
import { usePDFExport } from '../../hooks/usePDFExport';
import { PDFExportOptions } from '../../services/pdfExportService';

interface PDFExportModalProps {
  quiz: Quiz;
  isOpen: boolean;
  onClose: () => void;
}

export const PDFExportModal: React.FC<PDFExportModalProps> = ({
  quiz,
  isOpen,
  onClose
}) => {
  const { isExporting, exportError, exportToPDF } = usePDFExport();
  const [options, setOptions] = useState<PDFExportOptions>({
    includeAnswers: false,
    separateAnswerSheet: false,
    includeInstructions: true,
    pageFormat: 'A4',
    fontSize: 'medium',
    includeHeader: true,
    includeBranding: true
  });

  const handleExport = () => {
    exportToPDF(quiz, options);
    onClose();
  };

  const quickExportOptions = [
    {
      title: 'Quiz Only',
      description: 'Questions without answers for practice',
      icon: FileText,
      action: () => exportToPDF(quiz, { ...options, includeAnswers: false, separateAnswerSheet: false })
    },
    {
      title: 'With Answer Key',
      description: 'Questions with answers at the end',
      icon: Key,
      action: () => exportToPDF(quiz, { ...options, includeAnswers: true, separateAnswerSheet: false })
    },
    {
      title: 'Separate Answer Sheet',
      description: 'Quiz with bubble answer sheet',
      icon: ClipboardList,
      action: () => exportToPDF(quiz, { ...options, includeAnswers: true, separateAnswerSheet: true })
    }
  ];

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div className="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div className="flex items-center justify-between mb-6">
          <h2 className="text-xl font-semibold">Export Quiz to PDF</h2>
          <button
            onClick={onClose}
            className="text-gray-400 hover:text-gray-600"
          >
            <X className="w-5 h-5" />
          </button>
        </div>

        {/* Quick Export Options */}
        <div className="mb-6">
          <h3 className="text-lg font-medium mb-3">Quick Export</h3>
          <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
            {quickExportOptions.map((option, index) => (
              <button
                key={index}
                onClick={option.action}
                disabled={isExporting}
                className="p-4 border border-gray-200 rounded-lg hover:border-blue-300 hover:bg-blue-50 text-left transition-colors disabled:opacity-50"
              >
                <option.icon className="w-6 h-6 text-blue-600 mb-2" />
                <h4 className="font-medium text-sm">{option.title}</h4>
                <p className="text-xs text-gray-600 mt-1">{option.description}</p>
              </button>
            ))}
          </div>
        </div>

        {/* Custom Options */}
        <div className="border-t pt-6">
          <h3 className="text-lg font-medium mb-4">Custom Options</h3>
          
          <div className="space-y-4">
            {/* Answer Options */}
            <div>
              <label className="block text-sm font-medium mb-2">Answer Options</label>
              <div className="space-y-2">
                <label className="flex items-center">
                  <input
                    type="radio"
                    name="answers"
                    checked={!options.includeAnswers}
                    onChange={() => setOptions(prev => ({ ...prev, includeAnswers: false, separateAnswerSheet: false }))}
                    className="mr-2"
                  />
                  <span className="text-sm">No answers (practice mode)</span>
                </label>
                <label className="flex items-center">
                  <input
                    type="radio"
                    name="answers"
                    checked={options.includeAnswers && !options.separateAnswerSheet}
                    onChange={() => setOptions(prev => ({ ...prev, includeAnswers: true, separateAnswerSheet: false }))}
                    className="mr-2"
                  />
                  <span className="text-sm">Include answer key</span>
                </label>
                <label className="flex items-center">
                  <input
                    type="radio"
                    name="answers"
                    checked={options.includeAnswers && options.separateAnswerSheet}
                    onChange={() => setOptions(prev => ({ ...prev, includeAnswers: true, separateAnswerSheet: true }))}
                    className="mr-2"
                  />
                  <span className="text-sm">Separate answer sheet</span>
                </label>
              </div>
            </div>

            {/* Page Format */}
            <div>
              <label className="block text-sm font-medium mb-2">Page Format</label>
              <select
                value={options.pageFormat}
                onChange={(e) => setOptions(prev => ({ ...prev, pageFormat: e.target.value as 'A4' | 'Letter' }))}
                className="w-full p-2 border border-gray-300 rounded-md"
              >
                <option value="A4">A4</option>
                <option value="Letter">Letter</option>
              </select>
            </div>

            {/* Font Size */}
            <div>
              <label className="block text-sm font-medium mb-2">Font Size</label>
              <select
                value={options.fontSize}
                onChange={(e) => setOptions(prev => ({ ...prev, fontSize: e.target.value as 'small' | 'medium' | 'large' }))}
                className="w-full p-2 border border-gray-300 rounded-md"
              >
                <option value="small">Small</option>
                <option value="medium">Medium</option>
                <option value="large">Large</option>
              </select>
            </div>

            {/* Additional Options */}
            <div className="space-y-2">
              <label className="flex items-center">
                <input
                  type="checkbox"
                  checked={options.includeInstructions}
                  onChange={(e) => setOptions(prev => ({ ...prev, includeInstructions: e.target.checked }))}
                  className="mr-2"
                />
                <span className="text-sm">Include instructions</span>
              </label>
              <label className="flex items-center">
                <input
                  type="checkbox"
                  checked={options.includeHeader}
                  onChange={(e) => setOptions(prev => ({ ...prev, includeHeader: e.target.checked }))}
                  className="mr-2"
                />
                <span className="text-sm">Include quiz header</span>
              </label>
              <label className="flex items-center">
                <input
                  type="checkbox"
                  checked={options.includeBranding}
                  onChange={(e) => setOptions(prev => ({ ...prev, includeBranding: e.target.checked }))}
                  className="mr-2"
                />
                <span className="text-sm">Include branding</span>
              </label>
            </div>
          </div>

          {exportError && (
            <div className="mt-4 p-3 bg-red-50 border border-red-200 rounded-md">
              <p className="text-sm text-red-600">{exportError}</p>
            </div>
          )}

          <div className="flex justify-end space-x-3 mt-6">
            <button
              onClick={onClose}
              className="px-4 py-2 text-gray-600 hover:text-gray-800"
            >
              Cancel
            </button>
            <button
              onClick={handleExport}
              disabled={isExporting}
              className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50 flex items-center"
            >
              <Download className="w-4 h-4 mr-2" />
              {isExporting ? 'Exporting...' : 'Export PDF'}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
};
```

### 4. Integration with Quiz Components

Add export buttons to existing quiz components:

```typescript
// src/components/quiz/QuizActions.tsx
import React, { useState } from 'react';
import { Download, Share, Edit, Trash2 } from 'lucide-react';
import { Quiz } from '../../types/quiz';
import { PDFExportModal } from './PDFExportModal';

interface QuizActionsProps {
  quiz: Quiz;
  onEdit?: () => void;
  onDelete?: () => void;
  onShare?: () => void;
}

export const QuizActions: React.FC<QuizActionsProps> = ({
  quiz,
  onEdit,
  onDelete,
  onShare
}) => {
  const [showExportModal, setShowExportModal] = useState(false);

  return (
    <>
      <div className="flex items-center space-x-2">
        <button
          onClick={() => setShowExportModal(true)}
          className="flex items-center px-3 py-2 text-sm bg-blue-600 text-white rounded-md hover:bg-blue-700"
        >
          <Download className="w-4 h-4 mr-1" />
          Export PDF
        </button>
        
        {onShare && (
          <button
            onClick={onShare}
            className="flex items-center px-3 py-2 text-sm bg-green-600 text-white rounded-md hover:bg-green-700"
          >
            <Share className="w-4 h-4 mr-1" />
            Share
          </button>
        )}
        
        {onEdit && (
          <button
            onClick={onEdit}
            className="flex items-center px-3 py-2 text-sm bg-gray-600 text-white rounded-md hover:bg-gray-700"
          >
            <Edit className="w-4 h-4 mr-1" />
            Edit
          </button>
        )}
        
        {onDelete && (
          <button
            onClick={onDelete}
            className="flex items-center px-3 py-2 text-sm bg-red-600 text-white rounded-md hover:bg-red-700"
          >
            <Trash2 className="w-4 h-4 mr-1" />
            Delete
          </button>
        )}
      </div>

      <PDFExportModal
        quiz={quiz}
        isOpen={showExportModal}
        onClose={() => setShowExportModal(false)}
      />
    </>
  );
};
```

### 5. Bulk Export Feature

For exporting multiple quizzes:

```typescript
// src/components/quiz/BulkExportModal.tsx
import React, { useState } from 'react';
import { Quiz } from '../../types/quiz';
import { usePDFExport } from '../../hooks/usePDFExport';

interface BulkExportModalProps {
  quizzes: Quiz[];
  isOpen: boolean;
  onClose: () => void;
}

export const BulkExportModal: React.FC<BulkExportModalProps> = ({
  quizzes,
  isOpen,
  onClose
}) => {
  const { isExporting, exportToPDF } = usePDFExport();
  const [selectedQuizzes, setSelectedQuizzes] = useState<string[]>([]);

  const handleBulkExport = async () => {
    const selected = quizzes.filter(quiz => selectedQuizzes.includes(quiz.id));
    
    for (const quiz of selected) {
      await exportToPDF(quiz, {
        includeAnswers: false,
        separateAnswerSheet: false,
        includeInstructions: true,
        pageFormat: 'A4',
        fontSize: 'medium',
        includeHeader: true,
        includeBranding: true
      });
      
      // Small delay between exports
      await new Promise(resolve => setTimeout(resolve, 500));
    }
    
    onClose();
  };

  // Component implementation...
};
```

## Usage Examples

### Basic Export
```typescript
const { exportQuizOnly } = usePDFExport();

// Export quiz without answers
await exportQuizOnly(quiz);
```

### Custom Export
```typescript
const { exportToPDF } = usePDFExport();

const customOptions = {
  includeAnswers: true,
  separateAnswerSheet: true,
  pageFormat: 'Letter' as const,
  fontSize: 'large' as const,
  includeInstructions: false,
  includeHeader: true,
  includeBranding: false
};

await exportToPDF(quiz, customOptions);
```

## Features

- **Multiple Export Formats**: Quiz only, with answers, or with separate answer sheet
- **Customizable Layout**: Different page formats, font sizes, and styling options
- **Professional Formatting**: Clean, printable layouts with proper spacing
- **Answer Key Generation**: Automatic answer key with explanations
- **Bulk Export**: Export multiple quizzes at once
- **Branding Options**: Include/exclude app branding
- **Accessibility**: Proper contrast and readable fonts

## Future Enhancements

1. **Custom Templates**: Allow users to create custom PDF templates
2. **Image Support**: Include images from questions in PDF
3. **Watermarks**: Add custom watermarks for security
4. **Print Optimization**: Better print-specific formatting
5. **Cloud Storage**: Save PDFs to cloud storage services
6. **Email Integration**: Send PDFs directly via email

This PDF export system provides a comprehensive solution for users to create offline practice materials from their digital quizzes.